<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>{{LODGE_FULL_NAME}} — Publications</title>
<link rel="icon" type="image/png" href="{{LOGO_PATH}}">
<link rel="apple-touch-icon" href="{{LOGO_PATH}}">
<link rel="shortcut icon" type="image/png" href="{{LOGO_PATH}}">
<style>
  :root{--bg:#0f1115;--bg2:#151821;--card:#1b1f2a;--text:#eef3ff;--muted:#a9b4cf;--ring:#2c3756;--link:#9ecbff}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
  header{display:flex;align-items:center;gap:12px;padding:18px 20px;background:var(--bg2);border-bottom:1px solid var(--ring}}
  header img{height:36px}
  header h1{font-size:18px;margin:0}
  main{max-width:1000px;margin:24px auto;padding:0 16px}
  h2{margin:0 0 10px}
  .row{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:var(--card);border-radius:12px;overflow:hidden;border:1px solid var(--ring);color:inherit;text-decoration:none}
  .thumb{aspect-ratio:3/4;background:#0b0d12;display:grid;place-items:center}
  .thumb img{max-width:100%;max-height:100%;display:block}
  .meta{padding:10px 12px;display:flex;justify-content:space-between;gap:8px}
  .btn{background:var(--card);border:1px solid var(--ring);color:var(--text);padding:8px 10px;border-radius:10px;text-decoration:none;cursor:pointer}
  .btn:hover{border-color:#3c4a75}
  .muted{color:var(--muted}}
  footer{padding:24px;color:var(--muted);text-align:center}
  .notice{display:flex;gap:10px;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:10px 12px;margin-bottom:16px;flex-wrap:wrap}
</style>
</head>
<body>
<header class="site-header"
  data-crumbs='[["/"]]'
  data-back-text="Home" data-back-href="/"
  data-title="{{LODGE_FULL_NAME}} — Archive">
  <img class="logo" src="{{LOGO_PATH}}" alt="{{LODGE_SHORT_NAME}} logo">
  <nav class="crumbs" aria-label="Breadcrumb"></nav>
  <h1 class="page-title"></h1>
</header>
<script type="module">
  let v='dev';
  try{ const r=await fetch('/version.json',{cache:'no-store'}); if(r.ok){ const j=await r.json(); v=j.commit||'dev'; } }catch{}
  await import(`/assets/header.js?v=${encodeURIComponent(v)}`);
</script>
<style>
  .site-header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg2);border-bottom:1px solid var(--ring}}
  .site-header .logo{height:26px}
  .site-header .crumbs{display:flex;gap:8px;align-items:center;white-space:nowrap;overflow:auto}
  .site-header .crumbs a{color:var(--link);text-decoration:none}
  .site-header .sep{opacity:.5}
  .site-header .spacer{flex:1}
  .site-header .back{margin-left:8px;color:var(--link);text-decoration:none}
  .site-header .page-title{font-size:18px;margin:0}
  .site-header .logout{background:#1b1f2a;border:1px solid var(--ring);padding:6px 10px;border-radius:8px;color:#fff;text-decoration:none}
  .site-header .logout:hover{border-color:#3c4a75}
</style>
<main>
  <div id="members-top-notice" class="notice" style="display:none">
    <span class="muted">Content on this page is restricted to members only. You will need to sign in to view.</span>
    <a id="btn-top-signin" class="btn" href="/summons/">Sign in to view</a>
  </div>
  <section id="meetings-sec">
    <h2>Meetings</h2>
    <div id="meetings" class="row"></div>
  </section>
</main>

<footer>
  © <span id="y"></span> {{LODGE_FULL_NAME}} · Built with pdf.js + StPageFlip
</footer>

<script type="module">
  const ORIGIN = location.origin;
  const $ = sel => document.querySelector(sel);

  function mk(el, props={}, ...children){
    const node = document.createElement(el);
    for (const [k,v] of Object.entries(props||{})){
      if (k === 'class') node.className = v;
      else if (k === 'text') node.textContent = v;
      else node.setAttribute(k, v);
    }
    for (const ch of children) node.appendChild(typeof ch==='string' ? document.createTextNode(ch) : ch);
    return node;
  }

  function thumbUrlFor(pdf){
    const u = new URL(pdf, ORIGIN);
    return '/thumbnails' + u.pathname.replace(/\\.pdf$/i, '.jpg');
  }

  async function getBuildVersion(){
    try{ const r = await fetch('/version.json',{cache:'no-store'}); if (r.ok){ const j = await r.json(); return j.commit||'dev'; }}catch{}
    return 'dev';
  }

  function withV(url, v){
    try{ const u = new URL(url, ORIGIN); if (!u.searchParams.has('v')) u.searchParams.set('v', v); return u.toString(); }catch{ return url; }
  }

  function minutesNumberFromPath(path){
    const b = path.split('/').pop();
    const m = b.match(/{{SUMMONS_PREFIX}}-Minutes-(\\d{4})\\.pdf$/i);
    return m ? m[1] : '';
  }

  function summonsNumberFromPath(path){
    const b = path.split('/').pop();
    const m = b.match(/{{SUMMONS_PREFIX}}-Summons-(\\d{4})\\.pdf$/i);
    return m ? m[1] : '';
  }

  (async function(){
    const v = await getBuildVersion();
    $('#y').textContent = new Date().getFullYear();

    // Load meetings
    try {
      const res = await fetch('/publications.json', {cache:'no-store'});
      if (res.status === 401) {
        $('#members-top-notice').style.display = 'flex';
        $('#btn-top-signin').href = `/summons/?return=${encodeURIComponent(location.href)}`;
        return;
      }
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      if (Array.isArray(data.meetings) && data.meetings.length > 0) {
        const cards = data.meetings.map(m => {
          const a = mk('a', {class:'card', href: `/meetings/?id=${encodeURIComponent(m.meeting)}`});
          a.append(
            mk('div', {class:'thumb'}, mk('img', {src: thumbUrlFor(withV(m.summons, v)), alt: 'Meeting', loading:'lazy', decoding:'async'})),
            mk('div', {class:'meta'}, mk('strong', {text: `Meeting ${m.meeting}`}), mk('span', {class:'muted', text: m.date || ''}))
          );
          return a;
        });
        $('#meetings').replaceChildren(...cards);
      } else {
        $('#meetings').textContent = 'Nothing here yet.';
      }
    } catch (e) {
      console.error(e);
      $('#meetings').textContent = 'Unavailable.';
    }
  })();
</script>
</body>
</html>
