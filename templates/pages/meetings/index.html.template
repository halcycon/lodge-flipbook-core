<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Meetings — {{LODGE_FULL_NAME}}</title>
<link rel="icon" type="image/png" href="{{LOGO_PATH}}">
<link rel="apple-touch-icon" href="{{LOGO_PATH}}">
<link rel="shortcut icon" type="image/png" href="{{LOGO_PATH}}">
<style>
  :root{--bg:#0f1115;--bg2:#151821;--card:#1b1f2a;--text:#eef3ff;--muted:#a9b4cf;--ring:#2c3756;--link:#9ecbff}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
  main{max-width:1000px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 10px}
  h2{margin:0 0 10px}
  .hero{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;margin-bottom:20px}
  .hero .thumb{width:220px;aspect-ratio:3/4;background:#0b0d12;display:grid;place-items:center;border-radius:10px;overflow:hidden}
  .hero .thumb img{max-width:100%;max-height:100%;display:block}
  .bundle{margin-top:20px}
  .row{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:var(--card);border-radius:12px;overflow:hidden;border:1px solid var(--ring);color:inherit;text-decoration:none;display:block;transition:transform 0.2s}
  .card:hover{transform:translateY(-2px);border-color:#3c4a75}
  .thumb{aspect-ratio:3/4;background:#0b0d12;display:grid;place-items:center}
  .thumb img{max-width:100%;max-height:100%;display:block}
  .meta{padding:10px 12px;display:flex;justify-content:space-between;gap:8px;align-items:center}
  .btn{background:var(--card);border:1px solid var(--ring);color:var(--text);padding:8px 10px;border-radius:10px;text-decoration:none;cursor:pointer}
  .btn:hover{border-color:#3c4a75}
  .muted{color:var(--muted)}
  footer{padding:24px;color:var(--muted);text-align:center}
  .site-header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg2);border-bottom:1px solid var(--ring)}
  .site-header .logo{height:26px}
  .site-header .crumbs{display:flex;gap:8px;align-items:center;white-space:nowrap;overflow:auto}
  .site-header .crumbs a{color:var(--link);text-decoration:none}
  .site-header .sep{opacity:.5}
  .site-header .spacer{flex:1}
  .site-header .back{margin-left:8px;color:var(--link);text-decoration:none}
  .site-header .page-title{font-size:18px;margin:0}
  .site-header .logout{background:#1b1f2a;border:1px solid var(--ring);padding:6px 10px;border-radius:8px;color:#fff;text-decoration:none}
  .site-header .logout:hover{border-color:#3c4a75}
</style>
</head>
<body>
<header class="site-header"
  data-crumbs='[["/"]]'
  data-back-text="Home" data-back-href="/"
  data-title="{{LODGE_FULL_NAME}} — Meetings Archive">
  <img class="logo" src="{{LOGO_PATH}}" alt="{{LODGE_SHORT_NAME}} logo">
  <nav class="crumbs" aria-label="Breadcrumb"></nav>
  <h1 class="page-title"></h1>
</header>
<script type="module">
  let v='dev';
  try{ const r=await fetch('/version.json',{cache:'no-store'}); if(r.ok){ const j=await r.json(); v=j.commit||'dev'; } }catch{}
  await import(`/assets/header.js?v=${encodeURIComponent(v)}`);
</script>
<main>
  <!-- Show meeting list if no ID parameter -->
  <div id="meetings-index" style="display:none">
    <h2>All Meetings</h2>
    <p class="muted">View documents for any past or current meeting</p>
    <div id="meetings-list" class="row">
      <div class="muted">Loading…</div>
    </div>
  </div>

  <!-- Show single meeting if ID parameter present -->
  <div id="meeting-single" style="display:none">
    <div id="hero" class="hero">
      <div class="thumb"><small class="muted">Loading…</small></div>
      <div>
        <h1 id="mtitle"></h1>
        <p class="muted" id="msub"></p>
        <div id="primary-actions"></div>
      </div>
    </div>

    <div class="bundle">
      <h2>Documents</h2>
      <div id="bundle" class="row"></div>
    </div>
  </div>
</main>

<footer>
  © <span id="y"></span> {{LODGE_FULL_NAME}} · Built with pdf.js + StPageFlip
</footer>

<script type="module">
  const ORIGIN = location.origin;
  const $ = sel => document.querySelector(sel);
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  const meeting = (id || '').replace(/[^0-9]/g,'');

  function mk(el, props={}, ...children){
    const node = document.createElement(el);
    for (const [k,v] of Object.entries(props||{})){
      if (k === 'class') node.className = v;
      else if (k === 'text') node.textContent = v;
      else node.setAttribute(k, v);
    }
    for (const ch of children) node.appendChild(typeof ch==='string' ? document.createTextNode(ch) : ch);
    return node;
  }

  function thumbUrlFor(pdf){
    const u = new URL(pdf, ORIGIN);
    return '/thumbnails' + u.pathname.replace(/\.pdf$/i, '.jpg');
  }

  async function getBuildVersion(){
    try{ const r = await fetch('/version.json',{cache:'no-store'}); if (r.ok){ const j = await r.json(); return j.commit||'dev'; }}catch{}
    return 'dev';
  }

  function withV(url, v){
    try{ const u = new URL(url, ORIGIN); if (!u.searchParams.has('v')) u.searchParams.set('v', v); return u.toString(); }catch{ return url; }
  }

  function pad4(n){
    const x = Number(n)||0; return String(x).padStart(4,'0');
  }

  (async function(){
    const v = await getBuildVersion();
    $('#y').textContent = new Date().getFullYear();

    // No ID? Show meetings index
    if (!meeting) {
      $('#meetings-index').style.display = 'block';
      
      try {
        const res = await fetch('/meetings.json', {cache:'no-store'});
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        if (Array.isArray(data.meetings) && data.meetings.length > 0) {
          const cards = data.meetings.map(m => {
            const a = mk('a', {class:'card', href: `/meetings/?id=${m.meeting}`});
            a.append(
              mk('div', {class:'thumb'}, mk('img', {src: withV(m.thumbnail, v), alt: `Meeting ${m.meeting}`, loading:'lazy', decoding:'async'})),
              mk('div', {class:'meta'}, mk('strong', {text: `Meeting ${m.meeting}`}), mk('span', {class:'muted', text: '→'}))
            );
            return a;
          });
          $('#meetings-list').replaceChildren(...cards);
        } else {
          $('#meetings-list').textContent = 'No meetings found.';
        }
      } catch (e) {
        console.error(e);
        $('#meetings-list').textContent = 'Unable to load meetings.';
      }
    } 
    // Has ID? Show single meeting
    else {
      $('#meeting-single').style.display = 'block';
      
      const summonsPath = `/summons/{{SUMMONS_PREFIX}}${pad4(meeting)}.pdf`;
      const minutesPrev = `/minutes/{{MINUTES_PREFIX}}${pad4(meeting-1)}.pdf`;
      
      $('#hero .thumb').innerHTML = `<img src="${thumbUrlFor(summonsPath)}" alt="Summons" loading="lazy" decoding="async">`;
      $('#mtitle').textContent = `Meeting ${meeting}`;
      $('#msub').textContent = 'Summons and related documents';
      
      const btns = $('#primary-actions');
      btns.replaceChildren(
        mk('a', {class:'btn', href:`/viewer.html?pdf=${encodeURIComponent(withV(summonsPath, v))}`}, 'Open Summons'),
        mk('a', {class:'btn', href:`/viewer.html?pdf=${encodeURIComponent(withV(minutesPrev, v))}`}, 'Previous Minutes')
      );
    }
  })();
</script>
</body>
</html>
