<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Meeting — {{LODGE_FULL_NAME}}</title>
<link rel="icon" type="image/png" href="{{LOGO_PATH}}">
<style>
  :root{--bg:#0f1115;--bg2:#151821;--card:#1b1f2a;--text:#eef3ff;--muted:#a9b4cf;--ring:#2c3756}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui}
  .site-header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg2);border-bottom:1px solid var(--ring}}
  .site-header .logo{height:26px}
  .site-header .crumbs{display:flex;gap:8px;align-items:center;white-space:nowrap;overflow:auto}
  .site-header .crumbs a{color:#9ecbff;text-decoration:none}
  .site-header .sep{opacity:.5}
  .site-header .spacer{flex:1}
  .site-header .back{margin-left:8px;color:#9ecbff;text-decoration:none}
  .site-header .page-title{font-size:18px;margin:0}
  .site-header .logout{background:#1b1f2a;border:1px solid var(--ring);padding:6px 10px;border-radius:8px;color:#fff;text-decoration:none}
  .site-header .logout:hover{border-color:#3c4a75}
  main{max-width:1000px;margin:24px auto;padding:0 16px}
  .hero{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .thumb{width:220px;aspect-ratio:3/4;background:#0b0d12;display:grid;place-items:center;border-radius:10px;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;display:block}
  .bundle{margin-top:20px}
  .row{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:var(--card);border-radius:12px;overflow:hidden;border:1px solid var(--ring);color:inherit;text-decoration:none}
  .meta{padding:10px 12px;display:flex;justify-content:space-between;gap:8px}
  .muted{color:var(--muted)}
  .btn{background:var(--card);border:1px solid var(--ring);color:var(--text);padding:8px 10px;border-radius:10px;text-decoration:none;cursor:pointer}
</style>
</head>
<body>
<header class="site-header"
  data-crumbs='[["/","Archive"],["/publications/","Publications"]]'
  data-back-text="Archive" data-back-href="/publications/"
  data-title="Meeting Bundle">
  <img class="logo" src="{{LOGO_PATH}}" alt="{{LODGE_SHORT_NAME}} logo">
  <nav class="crumbs" aria-label="Breadcrumb"></nav>
  <h1 class="page-title"></h1>
</header>
<script type="module">
  let v='dev';
  try{ const r=await fetch('/version.json',{cache:'no-store'}); if(r.ok){ const j=await r.json(); v=j.commit||'dev'; } }catch{}
  await import(`/assets/header.js?v=${encodeURIComponent(v)}`);
</script>
<main>
  <div id="hero" class="hero">
    <div class="thumb"><small class="muted">Loading…</small></div>
    <div>
      <h1 id="mtitle"></h1>
      <p class="muted" id="msub"></p>
      <div id="primary-actions"></div>
    </div>
  </div>

  <div class="bundle">
    <h2>Documents</h2>
    <div id="bundle" class="row"></div>
  </div>
</main>
<script type="module">
  const $ = s => document.querySelector(s);
  const ORIGIN = location.origin;
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  const meeting = (id || '').replace(/[^0-9]/g,'');

  function thumbUrlFor(pdf){
    const u = new URL(pdf, ORIGIN);
    return '/thumbnails' + u.pathname.replace(/\.pdf$/i, '.jpg');
  }
  async function getBuildVersion(){
    try{ const r = await fetch('/version.json',{cache:'no-store'}); if (r.ok){ const j = await r.json(); return j.commit||'dev'; }}catch{}
    return 'dev';
  }
  function withV(url, v){
    try{ const u = new URL(url, ORIGIN); u.searchParams.set('v', v); return u.toString(); }catch{ return url; }
  }

  function pad4(n){
    const x = Number(n)||0; return String(x).padStart(4,'0');
  }
  function baseName(path){
    try{ const u = new URL(path, ORIGIN); return u.pathname.split('/').pop() || ''; }catch{ return String(path).split('/').pop() || ''; }
  }
  function minutesNumberFromPath(path){
    const b = baseName(path);
    const m = b.match(/{{SUMMONS_PREFIX}}-Minutes-(\\d{4})\\.pdf$/i);
    return m ? m[1] : '';
  }
  function summonsNumberFromPath(path){
    const b = baseName(path);
    const m = b.match(/{{SUMMONS_PREFIX}}-Summons-(\\d{4})\\.pdf$/i);
    return m ? m[1] : '';
  }

  if (!meeting){
    $('#hero .thumb').innerHTML = '<small class="muted">No meeting selected.</small>';
  } else {
    (async function(){
      const v = await getBuildVersion();
      const summonsPath = `/summons/{{SUMMONS_PREFIX}}-Summons-${pad4(meeting)}.pdf`;
      const minutesPrev = `/minutes/{{SUMMONS_PREFIX}}-Minutes-${pad4(meeting-1)}.pdf`;
      $('#hero .thumb').innerHTML = `<img src="${thumbUrlFor(summonsPath)}" alt="Summons" loading="lazy" decoding="async">`;
      $('#mtitle').textContent = `Meeting ${meeting}`;
      $('#msub').textContent = 'Summons and related documents';
      const btns = $('#primary-actions');
      btns.replaceChildren(
        el('a', {class:'btn', href:`/viewer.html?pdf=${encodeURIComponent(withV(summonsPath, v))}`}, 'Open Summons'),
        el('a', {class:'btn', href:`/viewer.html?pdf=${encodeURIComponent(withV(minutesPrev, v))}`}, 'Previous Minutes')
      );
    })();
  }

  function el(tag, props={}, ...kids){
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(props)){
      if (k==='class') n.className = v;
      else if (k==='text') n.textContent = v;
      else n.setAttribute(k,v);
    }
    kids.forEach(k=>n.appendChild(typeof k==='string'?document.createTextNode(k):k));
    return n;
  }
</script>
</body>
</html>
